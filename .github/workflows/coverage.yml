# Write a github action that will generate a coverage report

name: Coverage

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
    # This workflow contains a single job called "test"
    test:
        runs-on: ubuntu-latest
        strategy:
            max-parallel: 4
            matrix:
                python-version: [3.8]
            
        steps:
            # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
            - uses: actions/checkout@v2

            # Set up Python 3.8
            - name: Set up Python ${{ matrix.python-version }}
              uses: actions/setup-python@v2
              with:
                python-version: ${{ matrix.python-version }}

            # Install dependencies
            - name: Install Dependencies
              run: |
                python -m pip install --upgrade pip
                pip install -r requirements.txt

            # Generate coverage report
            - name: Generate Coverage Report
              run: |
                coverage run --source='.' --omit='suitedreams/wsgi.py','suitedreams/asgi.py','manage.py' manage.py test
                coverage report
                coverage html 

            - name: Upload coverage report to repo
              uses: actions/upload-artifact@v2
              with:
                name: coverage-report
                path: htmlcov/index.html

            - name: Delete old coverage badge if exists using actions/upload-artifact@v2
              uses: actions/upload-artifact@v2
              with:
                name: coverage-badge
                path: coverage.svg
                retention-days: 1
                if-no-files-found: continue

            - name: Generate coverage badge
              run: coverage-badge -f -o coverage.svg 
            
            - name: Upload coverage badge
              uses: actions/upload-artifact@v2
              with:
                name: coverage-badge
                path: coverage.svg

            
